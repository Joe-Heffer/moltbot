# Security audit workflow
# Runs moltbot security checks on a regular schedule
# Reference: https://docs.molt.bot/gateway/security

name: Security Audit

on:
  schedule:
    # Run weekly on Monday at 06:00 UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

concurrency:
  group: security-audit
  cancel-in-progress: false

env:
  MOLTBOT_USER: moltbot

permissions:
  contents: read

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Run deep security audit
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e

            echo "=== Moltbot Security Audit ==="

            # Use absolute path â€” the moltbot user's login shell may not
            # have ~/.npm-global/bin in PATH (useradd -r skips /etc/skel,
            # and non-interactive login shells may not source .profile).
            MOLTBOT_BIN="/home/${{ env.MOLTBOT_USER }}/.npm-global/bin/moltbot"
            if [ ! -x "$MOLTBOT_BIN" ]; then
              echo "FAIL: moltbot binary not found at $MOLTBOT_BIN"
              exit 1
            fi

            # Run deep audit first to surface all findings
            echo ""
            echo "--- Deep Audit ---"
            sudo -u ${{ env.MOLTBOT_USER }} "$MOLTBOT_BIN" security audit --deep

            # Apply safe automated fixes
            echo ""
            echo "--- Applying Fixes ---"
            sudo -u ${{ env.MOLTBOT_USER }} "$MOLTBOT_BIN" security audit --fix

            # The --fix flag skips chmod on symlinks for safety.
            # Resolve the symlink (if any) and harden the state dir ourselves.
            echo ""
            echo "--- Hardening State Directory ---"
            STATE_DIR="/home/${{ env.MOLTBOT_USER }}/.clawdbot"
            if [ -L "$STATE_DIR" ]; then
              REAL_DIR=$(readlink -f "$STATE_DIR")
              echo "State dir is symlink -> ${REAL_DIR}; fixing permissions on resolved path"
              sudo chmod 700 "$REAL_DIR"
            elif [ -d "$STATE_DIR" ]; then
              sudo chmod 700 "$STATE_DIR"
            fi

            # Re-run deep audit to confirm clean state
            echo ""
            echo "--- Verification Audit ---"
            AUDIT_OUTPUT=$(sudo -u ${{ env.MOLTBOT_USER }} "$MOLTBOT_BIN" security audit --deep 2>&1)
            echo "$AUDIT_OUTPUT"

            # Fail the workflow if any CRITICAL findings remain
            if echo "$AUDIT_OUTPUT" | grep -q "CRITICAL"; then
              echo ""
              echo "FAIL: Critical security findings remain after remediation"
              exit 1
            fi

            echo ""
            echo "=== Security Audit Complete ==="
