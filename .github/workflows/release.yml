name: Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type (auto-detects from commits if auto)'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  deployments: read

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(cat VERSION)
          echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Current version: $CURRENT_VERSION"

      - name: Analyze commits for version bump
        id: analyze
        run: |
          set +e

          # Get the last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            # No previous tags, use entire git history
            COMMITS=$(git log --oneline --pretty=format:"%s")
          else
            # Get commits since last tag
            COMMITS=$(git log "$LAST_TAG"..HEAD --oneline --pretty=format:"%s")
          fi

          # Determine version bump type
          VERSION_TYPE="${{ github.event.inputs.version_type }}"

          if [ "$VERSION_TYPE" = "auto" ]; then
            # Auto-detect from commit messages
            if echo "$COMMITS" | grep -iq "^BREAKING CHANGE"; then
              VERSION_TYPE="major"
            elif echo "$COMMITS" | grep -iq "^feat"; then
              VERSION_TYPE="minor"
            elif echo "$COMMITS" | grep -iq "^fix"; then
              VERSION_TYPE="patch"
            else
              VERSION_TYPE="patch"
            fi
          fi

          echo "version_type=$VERSION_TYPE" >> "$GITHUB_OUTPUT"
          echo "Detected version bump type: $VERSION_TYPE"
          echo "Commits since last release:"
          echo "$COMMITS"

      - name: Calculate next version
        id: next
        run: |
          CURRENT_VERSION="${{ steps.current.outputs.version }}"
          VERSION_TYPE="${{ steps.analyze.outputs.version_type }}"

          # Parse version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          case "$VERSION_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEXT_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "next_version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Next version: $NEXT_VERSION"

      - name: Update VERSION file
        run: |
          echo "${{ steps.next.outputs.next_version }}" > VERSION
          cat VERSION

      - name: Commit and tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add VERSION
          git commit -m "chore: bump version to ${{ steps.next.outputs.next_version }}"
          git tag -a "v${{ steps.next.outputs.next_version }}" -m "Release version ${{ steps.next.outputs.next_version }}"

      - name: Push changes and tags
        run: |
          git push origin HEAD:main
          git push origin "v${{ steps.next.outputs.next_version }}"

      - name: Generate release notes
        id: release_notes
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --reverse)
          else
            COMMITS=$(git log "$LAST_TAG"..HEAD --pretty=format:"- %s (%h)" --reverse)
          fi

          # Format release notes
          {
            echo "## What's Changed"
            echo ""
            echo "$COMMITS"
            echo ""
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$LAST_TAG...v${{ steps.next.outputs.next_version }}"
          } > release_notes.md

          cat release_notes.md

      - name: Create GitHub Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: v${{ steps.next.outputs.next_version }}
          name: v${{ steps.next.outputs.next_version }}
          bodyFile: release_notes.md
          draft: false
          prerelease: false
