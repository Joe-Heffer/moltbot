name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'deploy/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'update'
        type: choice
        options:
          - update
          - install
          - restart

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  MOLTBOT_USER: moltbot
  DEPLOY_PATH: /opt/moltbot-deploy

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e

            echo "=== Moltbot Deployment Started ==="

            # Determine action (from workflow_dispatch or default to update)
            ACTION="${{ github.event.inputs.action || 'update' }}"
            echo "Action: $ACTION"

            # Deploy directory is owned by the deploy user (created by setup-server.sh)
            cd ${{ env.DEPLOY_PATH }}

            # Clone or update the repository
            # No sudo — deploy user owns the directory
            if [ -d ".git" ]; then
              echo "Updating existing repository..."
              git fetch origin main
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            fi

            # Make scripts executable
            chmod +x deploy/*.sh

            # Disable errexit so diagnostics always run, even on failure
            set +e

            # Execute based on action
            case "$ACTION" in
              install)
                echo "Running full installation..."
                sudo ./deploy/install.sh
                ;;
              update)
                echo "Updating moltbot..."
                sudo ./deploy/update.sh
                ;;
              restart)
                echo "Restarting service..."
                sudo systemctl restart moltbot-gateway
                ;;
            esac
            DEPLOY_EXIT=$?

            set -e

            # Always show status (even on failure, for diagnostics)
            echo ""
            echo "=== Deployment Status ==="
            sudo systemctl status moltbot-gateway --no-pager || true
            echo ""
            sudo su - ${{ env.MOLTBOT_USER }} -c "moltbot --version" || echo "Moltbot not yet installed"

            # On failure, dump recent logs to help debug
            if [ "$DEPLOY_EXIT" -ne 0 ]; then
              echo ""
              echo "=== Deploy failed (exit $DEPLOY_EXIT) — recent service logs ==="
              sudo journalctl -u moltbot-gateway -n 50 --no-pager || true
              exit "$DEPLOY_EXIT"
            fi

            echo ""
            echo "=== Deployment Complete ==="

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for service to stabilize
        run: sleep 10

      - name: Check service health
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            echo "=== Health Check ==="

            # Check if service is running (no --quiet flag; sudoers doesn't allow it)
            SERVICE_STATE=$(sudo systemctl is-active moltbot-gateway || true)
            if [ "$SERVICE_STATE" = "active" ]; then
              echo "Service is running"
            else
              echo "Service is NOT running (state: $SERVICE_STATE)"
              sudo journalctl -u moltbot-gateway -n 20 --no-pager
              exit 1
            fi

            # Check if port is listening
            if ss -tlnp | grep -q ":18789"; then
              echo "Gateway is listening on port 18789"
            else
              echo "Gateway is NOT listening"
              exit 1
            fi

            echo "Health check passed"
