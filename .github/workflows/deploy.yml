name: Deploy to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'deploy/**'
      - 'VERSION'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - restart

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  MOLTBOT_USER: moltbot
  DEPLOY_PATH: /opt/moltbot-deploy

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: Get version
        id: version
        run: |
          DEPLOY_VERSION=$(cat VERSION)
          echo "version=$DEPLOY_VERSION" >> "$GITHUB_OUTPUT"
          echo "Deploying version: $DEPLOY_VERSION"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e

            echo "=== Moltbot Deployment Started ==="

            DEPLOY_DIR="${{ env.DEPLOY_PATH }}"
            DEPLOY_SCRIPT="${DEPLOY_DIR}/deploy/deploy.sh"

            # Determine action (from workflow_dispatch or default to deploy)
            ACTION="${{ github.event.inputs.action || 'deploy' }}"
            echo "Action: $ACTION"

            # Deploy directory is owned by the deploy user (created by setup-server.sh)
            cd "$DEPLOY_DIR"

            # Clone or update the repository
            # No sudo — deploy user owns the directory
            if [ -d ".git" ]; then
              echo "Updating existing repository..."
              git fetch origin main
              git reset --hard origin/main
            else
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            fi

            # Make scripts executable
            chmod +x deploy/*.sh

            # Verify sudo access before attempting deployment.
            # If setup-server.sh hasn't been (re-)run since script names
            # changed, the sudoers rules won't match and sudo will fail
            # with "a terminal is required to read the password".
            if [ "$ACTION" = "deploy" ]; then
              if ! sudo -n -l "$DEPLOY_SCRIPT" >/dev/null 2>&1; then
                echo ""
                echo "ERROR: Passwordless sudo is not configured for: $DEPLOY_SCRIPT"
                echo ""
                echo "The deploy user's sudoers rules are out of date."
                echo "SSH into the VPS as root and re-run setup-server.sh:"
                echo ""
                echo "  sudo ${DEPLOY_DIR}/deploy/setup-server.sh"
                echo ""
                exit 1
              fi
            fi

            # Disable errexit so diagnostics always run, even on failure
            set +e

            # Execute based on action
            case "$ACTION" in
              deploy)
                echo "Running deployment..."
                sudo "$DEPLOY_SCRIPT"
                ;;
              restart)
                echo "Restarting service..."
                sudo systemctl restart moltbot-gateway
                ;;
            esac
            DEPLOY_EXIT=$?

            set -e

            # Version tracking: deploy.sh saves /opt/moltbot-version when
            # ACTION=deploy.  For restarts the existing file is still valid.
            if [ -f /opt/moltbot-version ]; then
              echo "Deployed version: $(cat /opt/moltbot-version)"
            else
              echo "Deployed version: ${{ steps.version.outputs.version }} (not yet saved)"
            fi

            # Always show status (even on failure, for diagnostics)
            echo ""
            echo "=== Deployment Status ==="
            sudo systemctl status moltbot-gateway --no-pager || true
            echo ""
            sudo su - ${{ env.MOLTBOT_USER }} -c "moltbot --version" || echo "Moltbot not yet installed"
            echo ""
            echo "Repository version: ${{ steps.version.outputs.version }}"

            # On failure, dump recent logs to help debug
            if [ "$DEPLOY_EXIT" -ne 0 ]; then
              echo ""
              echo "=== Deploy failed (exit $DEPLOY_EXIT) — recent service logs ==="
              sudo journalctl -u moltbot-gateway -n 50 --no-pager || true
              exit "$DEPLOY_EXIT"
            fi

            echo ""
            echo "=== Deployment Complete ==="

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for service to stabilize
        run: sleep 10

      - name: Check service health
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            echo "=== Health Check ==="

            # Check if service is running (no --quiet flag; sudoers doesn't allow it)
            SERVICE_STATE=$(sudo systemctl is-active moltbot-gateway || true)
            if [ "$SERVICE_STATE" = "active" ]; then
              echo "Service is running"
            else
              echo "Service is NOT running (state: $SERVICE_STATE)"
              sudo journalctl -u moltbot-gateway -n 20 --no-pager
              exit 1
            fi

            # Check if port is listening
            if ss -tlnp | grep -q ":18789"; then
              echo "Gateway is listening on port 18789"
            else
              echo "Gateway is NOT listening"
              exit 1
            fi

            # Check deployed version
            if [ -f /opt/moltbot-version ]; then
              echo "Deployed version: $(cat /opt/moltbot-version)"
            fi

            echo "Health check passed"
