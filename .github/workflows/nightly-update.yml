# Nightly update workflow
# Checks for new openclaw releases and deploys them automatically.
# Uses the stable release channel (@latest tag).

name: Nightly Update

on:
  schedule:
    # Run daily at 03:00 UTC (off-peak hours)
    - cron: '0 3 * * *'
  workflow_dispatch:

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  OPENCLAW_USER: openclaw
  DEPLOY_PATH: /opt/openclaw-deploy

permissions:
  contents: read

jobs:
  nightly-update:
    name: Check & Update
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Check for new release version and update
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            echo "=== Nightly Update Check ==="

            OPENCLAW_BIN="/home/${{ env.OPENCLAW_USER }}/.npm-global/bin/openclaw"

            # Get currently installed version
            CURRENT="unknown"
            if [ -x "$OPENCLAW_BIN" ]; then
              CURRENT=$(sudo -u ${{ env.OPENCLAW_USER }} "$OPENCLAW_BIN" --version 2>/dev/null || echo "unknown")
            fi
            echo "Installed version: ${CURRENT}"

            # Get latest release version from npm registry
            LATEST=$(npm view openclaw@latest version 2>/dev/null || echo "unknown")
            echo "Latest release version: ${LATEST}"

            if [ "$LATEST" = "unknown" ]; then
              echo "Could not fetch latest release version from npm. Skipping update."
              exit 0
            fi

            if [ "$CURRENT" = "$LATEST" ]; then
              echo "Already on latest release (${CURRENT}). No update needed."
              exit 0
            fi

            echo ""
            echo "Update available: ${CURRENT} -> ${LATEST}"
            echo ""

            # Ensure deploy repo is current
            cd ${{ env.DEPLOY_PATH }}
            if [ -d ".git" ]; then
              echo "Pulling latest deploy scripts..."
              git fetch origin main
              git reset --hard origin/main
            fi

            chmod +x deploy/*.sh

            # Run the deployment (handles restart, health check, and doctor)
            # Use absolute path to match sudoers configuration
            sudo ${{ env.DEPLOY_PATH }}/deploy/deploy.sh

            echo ""
            echo "=== Nightly Update Complete: ${CURRENT} -> ${LATEST} ==="

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: nightly-update

    steps:
      - name: Wait for service to stabilize
        run: sleep 10

      - name: Check service health
        uses: appleboy/ssh-action@0ff4204d59e8e51228ff73bce53f80d53301dee2 # v1.2.5
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            echo "=== Health Check ==="

            SERVICE_STATE=$(sudo systemctl is-active openclaw-gateway || true)
            if [ "$SERVICE_STATE" = "active" ]; then
              echo "Service is running"
            else
              echo "Service is NOT running (state: ${SERVICE_STATE})"
              sudo journalctl -u openclaw-gateway -n 20 --no-pager
              exit 1
            fi

            if ss -tlnp | grep -q ":18789"; then
              echo "Gateway is listening on port 18789"
            else
              echo "Gateway is NOT listening"
              exit 1
            fi

            OPENCLAW_BIN="/home/${{ env.OPENCLAW_USER }}/.npm-global/bin/openclaw"
            if [ -x "$OPENCLAW_BIN" ]; then
              echo "Running version: $(sudo -u ${{ env.OPENCLAW_USER }} "$OPENCLAW_BIN" --version 2>/dev/null || echo 'unknown')"
            fi

            echo "Health check passed"
